name: Flutter Release Build

on:
  push:
    tags:
      - "v*" # Triggers when you push a tag like v1.0.2
  workflow_dispatch: # Allows manual run from the UI

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Essential for creating the release without a manual token

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- EXTRACT VERSION FROM PUBSPEC ---
      # This pulls the 'version: 1.2.3+4' from your pubspec.yaml 
      # to use as a fallback if no git tag is present.
      - name: Get Version from Pubspec
        id: pubspec_version
        run: |
          VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //')
          echo "VERSION=v$VERSION" >> $GITHUB_ENV

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------------- FLUTTER ----------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          channel: stable
          cache: true

      # ---------------- RESTORE FIREBASE CONFIG ----------------
      - name: Restore google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > android/app/google-services.json

      # ---------------- RESTORE ANDROID SIGNING KEY ----------------
      - name: Restore Android Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.jks

      # ---------- SET SIGNING ENVIRONMENT VARIABLES ----------
      - name: Set Signing Environment Variables
        run: |
          echo "KEYSTORE_PATH=$(pwd)/android/app/release.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      # ---------------- DEPENDENCIES ----------------
      - name: Install dependencies
        run: flutter pub get

      # ---------------- FULL FLAVOR ----------------
      - name: Build FULL APK
        run: |
          flutter build apk --release --flavor full --dart-define=BUNDLE_ALL_LANGS=true --analyze-size --target-platform android-arm64
          # Rename to match backend default download URL
          mv build/app/outputs/flutter-apk/app-full-release.apk build/app/outputs/flutter-apk/nanoplastics_app.apk || true

      # Clean only APK and app build cache for next flavor (keeps pub/gradle cache)
      - name: Prepare for LITE build
        run: |
          rm -rf build/app/outputs/flutter-apk/app-lite-release.apk
          rm -rf android/app/build/outputs/flutter-apk/app-lite-release.apk
          ./android/gradlew -p android/app clean -x :app:bundleFullRelease || true

      # ---------------- LITE FLAVOR ----------------
      - name: Build LITE APK
        run: |
          flutter build apk --release --flavor lite --dart-define=BUNDLE_ALL_LANGS=false --target-platform android-arm64
          # Rename to lite specific name
          mv build/app/outputs/flutter-apk/app-lite-release.apk build/app/outputs/flutter-apk/nanoplastics_app_lite.apk || true

      # Strip non-EN PDFs from LITE APK to reduce size
      - name: Strip non-EN PDFs from LITE APK
        run: |
          # Use absolute path
          APK_PATH="$GITHUB_WORKSPACE/build/app/outputs/flutter-apk/nanoplastics_app_lite.apk"
          TEMP_DIR=$(mktemp -d)
          
          echo "Original LITE APK size:"
          ls -lh "$APK_PATH"

          echo "Extracting LITE APK..."
          unzip -q "$APK_PATH" -d "$TEMP_DIR"
          
          echo "Searching and removing non-EN PDF files..."
          # Find files matching the non-EN patterns and remove them
          find "$TEMP_DIR" -name "*_CS_compressed.pdf" -delete
          find "$TEMP_DIR" -name "*_ES_compressed.pdf" -delete
          find "$TEMP_DIR" -name "*_FR_compressed.pdf" -delete
          find "$TEMP_DIR" -name "*_RU_compressed.pdf" -delete
          find "$TEMP_DIR" -name "CS_WATER_compressed.pdf" -delete
          
          echo "Repackaging LITE APK..."
          # Remove the original un-stripped APK so zip creates a fresh one
          rm "$APK_PATH"
          cd "$TEMP_DIR"
          zip -q -9 -r "$APK_PATH" .
          cd -
          
          rm -rf "$TEMP_DIR"
          
          echo "FINAL LITE APK size after stripping:"
          ls -lh "$APK_PATH"

          # IMPORTANT: Remove the original generated files so they don't get uploaded twice
          rm -f build/app/outputs/flutter-apk/app-*-release.apk

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          # Upload only our specifically named files
          path: build/app/outputs/flutter-apk/nanoplastics_app*.apk

      # ---------------- CREATE RELEASE ----------------
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          # Only release our specifically named files
          files: build/app/outputs/flutter-apk/nanoplastics_app*.apk
          # LOGIC: Use the Git Tag if available, otherwise use the version from pubspec
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || env.VERSION }}
          name: Release ${{ github.ref_type == 'tag' && github.ref_name || env.VERSION }}
          generate_release_notes: true