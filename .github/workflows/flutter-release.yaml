name: Flutter Release Build

on:
  push:
    tags:
      - "v*" # Triggers when you push a tag like v1.0.2
  workflow_dispatch: # Allows manual run from the UI

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Essential for creating the release without a manual token

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- GENERATE FIREBASE OPTIONS ---
      - name: Restore firebase_options.dart from secret
        run: |
          echo "${{ secrets.FIREBASE_OPTIONS_BASE64 }}" | base64 --decode > lib/firebase_options.dart

      # --- EXTRACT VERSION FROM PUBSPEC ---
      # This pulls the 'version: 1.2.3+4' from your pubspec.yaml
      # to use as a fallback if no git tag is present.
      - name: Get Version from Pubspec
        id: pubspec_version
        run: |
          VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //')
          echo "VERSION=v$VERSION" >> $GITHUB_ENV

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------------- FLUTTER ----------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          channel: stable
          cache: true

      # ---------------- RESTORE FIREBASE CONFIG ----------------
      - name: Restore google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > android/app/google-services.json

      # ---------------- RESTORE ANDROID SIGNING KEY ----------------
      - name: Restore Android Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.jks

      # ---------- SET SIGNING ENVIRONMENT VARIABLES ----------
      - name: Set Signing Environment Variables
        run: |
          echo "KEYSTORE_PATH=$(pwd)/android/app/release.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "BACKEND_URL=${{ secrets.BACKEND_URL_PROD }}" >> $GITHUB_ENV
          echo "WEBHOOK_SECRET=${{ secrets.RELEASE_WEBHOOK_SECRET }}" >> $GITHUB_ENV

      # ---------- INSTALL YQ ----------
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      # ---------- BACKUP ORIGINAL PUBSPEC ------
      - name: Backup original pubspec
        run: cp pubspec.yaml pubspec.yaml.bak

      # ---------- GENERATE FULL PUBSPEC ------
      - name: Generate FULL pubspec
        run: |
          cp pubspec.base.yaml pubspec.yaml
          yq -i '.flutter.assets += load("pubspec.full.yaml").flutter.assets' pubspec.yaml
          # Sync version from original pubspec so APK version matches the git tag
          ORIG_VERSION=$(grep '^version:' pubspec.yaml.bak | sed 's/version: //')
          yq -i ".version = \"$ORIG_VERSION\"" pubspec.yaml
          echo "Generated FULL pubspec.yaml with version $ORIG_VERSION"

      # ---------- VALIDATE PUBSPEC ------
      - name: Validate pubspec.yaml
        run: |
          echo "Validating pubspec.yaml..."
          if ! grep -q "^name:" pubspec.yaml; then
            echo "ERROR: pubspec.yaml is invalid - missing 'name' field"
            exit 1
          fi
          if ! grep -q "^version:" pubspec.yaml; then
            echo "ERROR: pubspec.yaml is invalid - missing 'version' field"
            exit 1
          fi
          echo "pubspec.yaml is valid"

      # --- VALIDATE BACKEND URL ---
      - name: Validate Backend Configuration
        run: |
          if [ -z "${{ secrets.BACKEND_URL_PROD }}" ]; then
            echo "ERROR: BACKEND_URL_PROD secret is not set"
            exit 1
          fi
          echo "Backend URL configured for production build"

      # ---------------- DEPENDENCIES ----------------
      - name: Install dependencies
        run: flutter pub get

      # ---------------- QUALITY GATES ----------------
      - name: Check dart formatting
        run: |
          dart format lib/firebase_options.dart  # normalize restored generated file
          dart format lib/ --set-exit-if-changed

      - name: Run Flutter Analyze
        run: flutter analyze

      - name: Run Tests
        run: flutter test

      # ---------------- L10N GENERATION ----------------
      - name: Generate l10n files
        run: bash run_generate_langs.sh

      # ---------------- FULL FLAVOR APK (sideload / in-app update) ----------------
      - name: Build FULL APK
        run: |
          flutter build apk --release --flavor full --dart-define=BUNDLE_ALL_LANGS=true --dart-define=BACKEND_URL=${{ env.BACKEND_URL }}
          mv build/app/outputs/flutter-apk/app-full-release.apk build/app/outputs/flutter-apk/nanoplastics_app.apk

      # ---------- BUILD PLAY FLAVOR AAB (Google Play Store only) ------
      - name: Build PLAY AAB (Google Play)
        run: |
          flutter build appbundle --release --flavor play --dart-define=BUNDLE_ALL_LANGS=true --dart-define=BACKEND_URL=${{ env.BACKEND_URL }} --dart-define=IS_PLAY_STORE=true
          cp build/app/outputs/bundle/playRelease/app-play-release.aab build/app/outputs/bundle/playRelease/nanoplastics_app_play.aab || true

      # ---------- GENERATE LITE PUBSPEC ------
      - name: Generate LITE pubspec
        run: |
          cp pubspec.base.yaml pubspec.yaml
          ORIG_VERSION=$(grep '^version:' pubspec.yaml.bak | sed 's/version: //')
          yq -i ".version = \"$ORIG_VERSION\"" pubspec.yaml
          echo "Generated LITE pubspec.yaml with version $ORIG_VERSION"

      # ---------------- DEPENDENCIES FOR LITE ----------------
      - name: Install dependencies for LITE
        run: flutter pub get

      # ---------------- LITE FLAVOR APK (sideload / in-app update) ----------------
      - name: Build LITE APK
        run: |
          flutter build apk --release --flavor lite --dart-define=BUNDLE_ALL_LANGS=false --dart-define=BACKEND_URL=${{ env.BACKEND_URL }}
          mv build/app/outputs/flutter-apk/app-lite-release.apk build/app/outputs/flutter-apk/nanoplastics_app_lite.apk

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            build/app/outputs/flutter-apk/nanoplastics_app*.apk
            build/app/outputs/bundle/playRelease/nanoplastics_app_play.aab

      # ---------------- CREATE RELEASE ----------------
      - name: Publish Release
        id: publish_release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/app/outputs/flutter-apk/nanoplastics_app.apk
            build/app/outputs/flutter-apk/nanoplastics_app_lite.apk
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || env.VERSION }}
          name: Release ${{ github.ref_type == 'tag' && github.ref_name || env.VERSION }}
          generate_release_notes: true
          body: |
            ## Download

            | Variant | Size | Languages |
            |---------|------|-----------|
            | **nanoplastics_app.apk** | ~85 MB | EN 路 CS 路 ES 路 FR 路 RU |
            | **nanoplastics_app_lite.apk** | ~45 MB | EN only |

            Play Store build (AAB): available in Google Play Console.

      # ---------------- NOTIFY BACKEND ----------------
      - name: Notify backend of new release
        if: env.WEBHOOK_SECRET != '' && env.BACKEND_URL != ''
        env:
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "$GITHUB_REF_TYPE" = "tag" ]; then
            RELEASE_TAG="$GITHUB_REF_NAME"
          else
            RELEASE_TAG="$VERSION"
          fi
          # Strip leading 'v' for the version field
          VERSION="${RELEASE_TAG#v}"
          REPO="glmcz/nanoplastics_frontend"
          FULL_URL="https://github.com/$REPO/releases/download/$RELEASE_TAG/nanoplastics_app.apk"
          LITE_URL="https://github.com/$REPO/releases/download/$RELEASE_TAG/nanoplastics_app_lite.apk"
          curl -sf -X POST "$BACKEND_URL/api/release" \
            -H "Authorization: Bearer $WEBHOOK_SECRET" \
            -H "Content-Type: application/json" \
            -d "{\"version\":\"$VERSION\",\"full_apk_url\":\"$FULL_URL\",\"lite_apk_url\":\"$LITE_URL\",\"published_at\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"notes\":null}" \
            || echo "Backend webhook failed (non-fatal)"
