name: Flutter Release Build

on:
  push:
    tags:
      - "v*" # Triggers when you push a tag like v1.0.2
  workflow_dispatch: # Allows manual run from the UI

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Essential for creating the release without a manual token

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- EXTRACT VERSION FROM PUBSPEC ---
      # This pulls the 'version: 1.2.3+4' from your pubspec.yaml 
      # to use as a fallback if no git tag is present.
      - name: Get Version from Pubspec
        id: pubspec_version
        run: |
          VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //')
          echo "VERSION=v$VERSION" >> $GITHUB_ENV

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------------- FLUTTER ----------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          channel: stable
          cache: true

      # ---------------- RESTORE FIREBASE CONFIG ----------------
      - name: Restore google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > android/app/google-services.json

      # ---------------- RESTORE ANDROID SIGNING KEY ----------------
      - name: Restore Android Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.jks

      # ---------- SET SIGNING ENVIRONMENT VARIABLES ----------
      - name: Set Signing Environment Variables
        run: |
          echo "KEYSTORE_PATH=$(pwd)/android/app/release.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "BACKEND_URL=${{ secrets.BACKEND_URL_PROD }}" >> $GITHUB_ENV

      # ---------- INSTALL YQ ----------
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      # ---------- BACKUP ORIGINAL PUBSPEC ------
      - name: Backup original pubspec
        run: cp pubspec.yaml pubspec.yaml.bak

      # ---------- GENERATE FULL PUBSPEC ------
      - name: Generate FULL pubspec
        run: |
          cp pubspec.base.yaml pubspec.yaml
          yq -i '.flutter.assets += load("pubspec.full.yaml").flutter.assets' pubspec.yaml
          echo "Generated FULL pubspec.yaml"

      # ---------- VALIDATE PUBSPEC ------
      - name: Validate pubspec.yaml
        run: |
          echo "Validating pubspec.yaml..."
          if ! grep -q "^name:" pubspec.yaml; then
            echo "ERROR: pubspec.yaml is invalid - missing 'name' field"
            exit 1
          fi
          if ! grep -q "^version:" pubspec.yaml; then
            echo "ERROR: pubspec.yaml is invalid - missing 'version' field"
            exit 1
          fi
          echo "pubspec.yaml is valid"

      # --- VALIDATE BACKEND URL ---
      - name: Validate Backend Configuration
        run: |
          if [ -z "${{ secrets.BACKEND_URL_PROD }}" ]; then
            echo "ERROR: BACKEND_URL_PROD secret is not set"
            exit 1
          fi
          echo "Backend URL configured for production build"

      # ---------------- DEPENDENCIES ----------------
      - name: Install dependencies
        run: flutter pub get

      # ---------------- L10N GENERATION ----------------
      - name: Generate l10n files
        run: bash run_generate_langs.sh

      # ---------------- FULL FLAVOR ----------------
      - name: Build FULL APK
        run: |
          flutter build apk --release --flavor full --dart-define=BUNDLE_ALL_LANGS=true --dart-define=BACKEND_URL=${{ env.BACKEND_URL }} --analyze-size --target-platform android-arm64
          # Rename to match backend default download URL
          mv build/app/outputs/flutter-apk/app-full-release.apk build/app/outputs/flutter-apk/nanoplastics_app.apk || true

      # ---------- GENERATE LITE PUBSPEC ------
      - name: Generate LITE pubspec
        run: |
          cp pubspec.base.yaml pubspec.yaml
          echo "Generated LITE pubspec.yaml"

      # ---------------- DEPENDENCIES FOR LITE ----------------
      - name: Install dependencies for LITE
        run: flutter pub get

      # ---------------- LITE FLAVOR ----------------
      - name: Build LITE APK
        run: |
          flutter build apk --release --flavor lite --dart-define=BUNDLE_ALL_LANGS=false --dart-define=BACKEND_URL=${{ env.BACKEND_URL }} --analyze-size --target-platform android-arm64
          # Rename to lite specific name
          mv build/app/outputs/flutter-apk/app-lite-release.apk build/app/outputs/flutter-apk/nanoplastics_app_lite.apk || true

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          # Upload only our specifically named files
          path: build/app/outputs/flutter-apk/nanoplastics_app*.apk

      # ---------------- CREATE RELEASE ----------------
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          # Only release our specifically named files
          files: build/app/outputs/flutter-apk/nanoplastics_app*.apk
          # LOGIC: Use the Git Tag if available, otherwise use the version from pubspec
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || env.VERSION }}
          name: Release ${{ github.ref_type == 'tag' && github.ref_name || env.VERSION }}
          generate_release_notes: true